<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Scheduler: วางแผนลงทะเบียนเรียน</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; /* Indigo */
            --primary-light: #e0e7ff;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
            --border: #e5e7eb;
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        /* --- Layout --- */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
            align-items: start;
        }

        /* --- Header & Plan Switcher --- */
        .top-bar {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: var(--surface);
            padding: 16px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand h1 { margin: 0; font-size: 1.25rem; color: var(--primary); }
        .brand i { font-size: 1.5rem; color: var(--primary); }

        .plan-selector {
            display: flex;
            background: var(--bg);
            padding: 4px;
            border-radius: 12px;
        }
        .plan-btn {
            border: none;
            background: transparent;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            font-weight: 500;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .plan-btn.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* --- Card Component --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        h3 { margin-top: 0; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }

        /* --- Form --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-group.full { grid-column: 1 / -1; }
        
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.85rem; color: var(--text); }
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Prompt', sans-serif;
            font-size: 0.95rem;
            transition: 0.2s;
            background: #f9fafb;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* --- Buttons --- */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: var(--primary);
            color: white;
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-ghost { background: transparent; color: var(--text-muted); width: auto; padding: 8px; }
        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 6px; display: inline-flex; }

        /* --- Stats --- */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: var(--primary-light);
            color: var(--primary);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* --- Schedule Table --- */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; table-layout: fixed; }
        
        th {
            background: #f8fafc;
            color: var(--text-muted);
            font-weight: 600;
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            text-transform: uppercase;
            width: 8.33%; /* 12 columns */
        }
        th:first-child { width: 60px; position: sticky; left: 0; z-index: 10; border-right: 1px solid var(--border); }

        td {
            height: 70px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid #f3f4f6;
            position: relative;
            padding: 0;
            vertical-align: top;
        }
        td:first-child {
            background: #ffffff;
            color: var(--text);
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border-right: 1px solid var(--border);
            position: sticky; left: 0; z-index: 10;
        }

        /* --- Course Block --- */
        .course-block {
            position: absolute;
            top: 2px; bottom: 2px; left: 2px; right: 2px;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 0.75rem;
            color: #fff;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 5;
            display: flex;
            flex-direction: column;
            line-height: 1.3;
        }
        .course-block:hover { transform: scale(1.02); z-index: 20; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .course-block:active { cursor: grabbing; }
        .course-title { font-weight: 700; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .course-detail { opacity: 0.9; font-size: 0.7rem; white-space: nowrap; }
        
        .btn-delete-xs {
            position: absolute; top: 2px; right: 4px;
            background: rgba(0,0,0,0.2);
            border: none; color: #fff;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 10px;
            opacity: 0; transition: 0.2s;
        }
        .course-block:hover .btn-delete-xs { opacity: 1; }

        .conflict-pattern {
            background-image: repeating-linear-gradient(45deg, rgba(255,0,0,0.1), rgba(255,0,0,0.1) 10px, rgba(255,0,0,0.2) 10px, rgba(255,0,0,0.2) 20px);
            border: 2px dashed #ef4444;
        }

        /* --- Drag State --- */
        .drag-over { background: var(--primary-light) !important; }

        /* --- List Item --- */
        .course-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            background: #f9fafb;
            margin-bottom: 8px;
            border-left: 4px solid transparent;
        }
        .course-list-item:hover { background: #f3f4f6; }

        /* --- Mobile --- */
        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; gap: 12px; align-items: stretch; }
            .plan-selector { justify-content: center; }
        }
        
        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #1f2937; color: white;
            padding: 12px 24px; border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 10px;
            animation: slideUp 0.3s forwards;
            z-index: 9999;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="app-container">
        <div class="top-bar">
            <div class="brand">
                <i class="fa-solid fa-graduation-cap"></i>
                <div>
                    <h1 style="line-height:1">Smart Reg</h1>
                    <small style="color:var(--text-muted)">วางแผนลงทะเบียนเรียน</small>
                </div>
            </div>
            <div class="plan-selector">
                <button class="plan-btn active" onclick="switchPlan('planA')">แผนหลัก (A)</button>
                <button class="plan-btn" onclick="switchPlan('planB')">แผนสำรอง 1 (B)</button>
                <button class="plan-btn" onclick="switchPlan('planC')">แผนสำรอง 2 (C)</button>
            </div>
            <div>
                <button class="btn btn-secondary" id="export-btn" style="width:auto; padding:8px 16px;">
                    <i class="fa-solid fa-download"></i> ส่งออก (PDF)
                </button>
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="card">
                <h3><i class="fa-solid fa-plus-circle"></i> เพิ่มวิชาเรียน</h3>
                
                <div class="form-group full">
                    <label>รหัส/ชื่อวิชา</label>
                    <input type="text" id="c-name" placeholder="เช่น 010063004 - Web Programming">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>ตอนเรียน (Sec)</label>
                        <input type="text" id="c-sec" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>หน่วยกิต</label>
                        <input type="number" id="c-credit" value="3" min="0" max="10">
                    </div>
                </div>

                <div class="form-group full">
                    <label>ชื่อผู้สอน (ถ้ามี)</label>
                    <input type="text" id="c-teacher" placeholder="อ.สมชาย">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>วันเรียน</label>
                        <select id="c-day">
                            <option value="mon">จันทร์</option>
                            <option value="tue">อังคาร</option>
                            <option value="wed">พุธ</option>
                            <option value="thu">พฤหัสบดี</option>
                            <option value="fri">ศุกร์</option>
                            <option value="sat">เสาร์</option>
                            <option value="sun">อาทิตย์</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>เวลา</label>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <select id="c-start" style="padding-right:0"></select>
                            <span>-</span>
                            <select id="c-end" style="padding-right:0"></select>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:16px;">
                    <button class="btn" id="add-btn"><i class="fa-solid fa-check"></i> เพิ่มวิชา</button>
                    <button class="btn btn-secondary btn-icon" id="cancel-btn" style="display:none" title="ยกเลิกแก้ไข"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <div class="card" style="flex-grow:1">
                <h3><i class="fa-solid fa-list"></i> รายวิชา (<span id="course-count">0</span>)</h3>
                <div class="stats-bar">
                    <span>รวมหน่วยกิต</span>
                    <span id="total-credits">0</span>
                </div>
                <div id="course-list" style="max-height: 400px; overflow-y:auto;">
                    <div style="text-align:center; color:#aaa; padding:20px;">ยังไม่มีวิชาในแผนนี้</div>
                </div>
                <button class="btn btn-danger" onclick="clearPlan()" style="margin-top:16px; background:transparent; border:1px solid #fee2e2; color:#ef4444;">
                    <i class="fa-solid fa-trash"></i> ล้างตารางแผนนี้
                </button>
            </div>
        </div>

        <div class="card" id="schedule-capture-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="margin:0;"><i class="fa-regular fa-calendar"></i> ตารางเรียน</h3>
                <span id="current-plan-label" style="background:var(--primary-light); color:var(--primary); padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600;">แผน A</span>
            </div>

            <div class="table-container">
                <table id="schedule-table">
                    <thead>
                        <tr id="header-row">
                            <th>วัน/เวลา</th>
                            </tr>
                    </thead>
                    <tbody id="schedule-body">
                        </tbody>
                </table>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; color:var(--text-muted); text-align:right;">
                * สามารถลากวิชาเพื่อเปลี่ยนเวลาได้
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CONFIG = {
            hours: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
            days: ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'],
            dayLabels: {mon:'จันทร์', tue:'อังคาร', wed:'พุธ', thu:'พฤหัส', fri:'ศุกร์', sat:'เสาร์', sun:'อาทิตย์'},
            colors: [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'
            ]
        };

        let state = {
            currentPlan: 'planA',
            data: {
                planA: [],
                planB: [],
                planC: []
            },
            editingId: null
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initSelects();
            initTable();
            render();
        });

        function initSelects() {
            const start = document.getElementById('c-start');
            const end = document.getElementById('c-end');
            
            CONFIG.hours.forEach(h => {
                if (h === 20) return; // Don't start at 20:00
                let opt = new Option(`${h}:00`, h);
                start.add(opt);
            });

            const updateEnd = () => {
                const sVal = parseInt(start.value);
                end.innerHTML = '';
                CONFIG.hours.forEach(h => {
                    if (h > sVal) {
                        let opt = new Option(`${h}:00`, h);
                        end.add(opt);
                    }
                });
                // Default duration 3 hours or max possible
                end.value = Math.min(sVal + 3, 20);
            };

            start.addEventListener('change', updateEnd);
            updateEnd();
        }

        function initTable() {
            const header = document.getElementById('header-row');
            CONFIG.hours.forEach(h => {
                if(h === 20) return; // Don't show column for 20:00 start
                let th = document.createElement('th');
                th.textContent = `${h}:00`;
                header.appendChild(th);
            });

            const tbody = document.getElementById('schedule-body');
            CONFIG.days.forEach(day => {
                let tr = document.createElement('tr');
                
                // Day Label
                let tdDay = document.createElement('td');
                tdDay.innerHTML = day === 'sat' || day === 'sun' 
                    ? `<span style="color:#ef4444">${CONFIG.dayLabels[day]}</span>` 
                    : CONFIG.dayLabels[day];
                tr.appendChild(tdDay);

                // Time Slots
                for(let i=0; i<CONFIG.hours.length-1; i++) {
                    let td = document.createElement('td');
                    td.dataset.day = day;
                    td.dataset.hour = CONFIG.hours[i];
                    td.className = 'drop-zone';
                    
                    // Drag Events
                    td.addEventListener('dragover', handleDragOver);
                    td.addEventListener('dragleave', handleDragLeave);
                    td.addEventListener('drop', handleDrop);

                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
        }

        // --- Core Logic ---
        function getCourses() {
            return state.data[state.currentPlan];
        }

        function setCourses(courses) {
            state.data[state.currentPlan] = courses;
            saveData();
            render();
        }

        function saveData() {
            localStorage.setItem('smart_reg_data', JSON.stringify(state.data));
        }

        function loadData() {
            const saved = localStorage.getItem('smart_reg_data');
            if (saved) {
                state.data = JSON.parse(saved);
            }
        }

        function switchPlan(planId) {
            state.currentPlan = planId;
            // Update Buttons
            document.querySelectorAll('.plan-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="switchPlan('${planId}')"]`).classList.add('active');
            
            // Update UI Label
            const label = { planA: 'แผนหลัก (A)', planB: 'แผนสำรอง 1 (B)', planC: 'แผนสำรอง 2 (C)' };
            document.getElementById('current-plan-label').textContent = label[planId];

            resetForm();
            render();
            showToast(`เปลี่ยนเป็น ${label[planId]} เรียบร้อย`);
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            // Use hash to pick from palette
            const index = Math.abs(hash) % CONFIG.colors.length;
            return CONFIG.colors[index];
        }

        // --- Rendering ---
        function render() {
            const courses = getCourses();
            
            // 1. Clear Table Slots
            document.querySelectorAll('.drop-zone').forEach(td => {
                td.innerHTML = '';
                td.classList.remove('conflict-pattern');
            });

            // 2. Render Courses on Table
            courses.forEach(c => {
                const duration = c.end - c.start;
                const color = stringToColor(c.name);
                
                // Find Target Cell
                const selector = `.drop-zone[data-day="${c.day}"][data-hour="${c.start}"]`;
                const cell = document.querySelector(selector);

                if (cell) {
                    const div = document.createElement('div');
                    div.className = 'course-block';
                    div.draggable = true;
                    div.style.backgroundColor = color;
                    // Calculate Width: (100% + 1px border) * duration - border spacing
                    div.style.width = `calc(${duration * 100}% + ${duration}px - 5px)`;
                    
                    div.innerHTML = `
                        <div class="course-title">${c.name}</div>
                        <div class="course-detail">Sec ${c.sec} (${c.start}:00-${c.end}:00)</div>
                        <button class="btn-delete-xs" onclick="deleteCourse('${c.id}', event)">×</button>
                    `;

                    div.dataset.id = c.id;
                    div.addEventListener('dragstart', handleDragStart);
                    div.addEventListener('click', (e) => {
                        if(!e.target.classList.contains('btn-delete-xs')) editCourse(c.id);
                    });

                    // Conflict Detection Check
                    if (isConflict(c, courses)) {
                        div.classList.add('conflict-pattern');
                        div.title = "เวลาเรียนชนกัน!";
                        div.innerHTML += ` <i class="fa-solid fa-triangle-exclamation" style="color:yellow"></i>`;
                    }

                    cell.appendChild(div);
                }
            });

            // 3. Render Side List
            const list = document.getElementById('course-list');
            list.innerHTML = '';
            let totalCredits = 0;

            // Sort by Day then Time
            const sorted = [...courses].sort((a,b) => {
                const dayDiff = CONFIG.days.indexOf(a.day) - CONFIG.days.indexOf(b.day);
                if (dayDiff !== 0) return dayDiff;
                return a.start - b.start;
            });

            if (sorted.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#ccc; padding:30px;">ยังไม่มีวิชา<br>กดเพิ่มวิชาได้เลย</div>`;
            } else {
                sorted.forEach(c => {
                    totalCredits += parseInt(c.credit || 0);
                    const color = stringToColor(c.name);
                    const item = document.createElement('div');
                    item.className = 'course-list-item';
                    item.style.borderLeftColor = color;
                    item.innerHTML = `
                        <div>
                            <div style="font-weight:600; font-size:0.95rem;">${c.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">
                                ${CONFIG.dayLabels[c.day]} ${c.start}:00-${c.end}:00 | Sec ${c.sec} | ${c.credit} หน่วยกิต
                            </div>
                        </div>
                        <div style="display:flex; gap:4px;">
                            <button class="btn-ghost" onclick="editCourse('${c.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-ghost" style="color:var(--danger)" onclick="deleteCourse('${c.id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            
            document.getElementById('course-count').textContent = courses.length;
            document.getElementById('total-credits').textContent = totalCredits;
        }

        function isConflict(course, allCourses) {
            return allCourses.some(c => 
                c.id !== course.id && 
                c.day === course.day && 
                ( (course.start < c.end && course.end > c.start) )
            );
        }

        // --- Actions ---
        document.getElementById('add-btn').addEventListener('click', () => {
            const name = document.getElementById('c-name').value.trim();
            const sec = document.getElementById('c-sec').value;
            const credit = document.getElementById('c-credit').value;
            const teacher = document.getElementById('c-teacher').value;
            const day = document.getElementById('c-day').value;
            const start = parseInt(document.getElementById('c-start').value);
            const end = parseInt(document.getElementById('c-end').value);

            if (!name) return showToast('กรุณากรอกชื่อวิชา', 'error');
            
            const course = {
                id: state.editingId || Date.now().toString(),
                name, sec, credit, teacher, day, start, end
            };

            let courses = getCourses();
            if (state.editingId) {
                const index = courses.findIndex(c => c.id === state.editingId);
                courses[index] = course;
                showToast('แก้ไขข้อมูลสำเร็จ');
            } else {
                courses.push(course);
                showToast('เพิ่มวิชาสำเร็จ');
            }

            setCourses(courses);
            resetForm();
        });

        function editCourse(id) {
            const course = getCourses().find(c => c.id === id);
            if (!course) return;

            document.getElementById('c-name').value = course.name;
            document.getElementById('c-sec').value = course.sec;
            document.getElementById('c-credit').value = course.credit;
            document.getElementById('c-teacher').value = course.teacher;
            document.getElementById('c-day').value = course.day;
            document.getElementById('c-start').value = course.start;
            
            // Trigger change to update end options, then set value
            const event = new Event('change');
            document.getElementById('c-start').dispatchEvent(event);
            document.getElementById('c-end').value = course.end;

            state.editingId = id;
            
            const addBtn = document.getElementById('add-btn');
            addBtn.innerHTML = '<i class="fa-solid fa-save"></i> บันทึก';
            addBtn.style.backgroundColor = '#f59e0b';
            document.getElementById('cancel-btn').style.display = 'inline-flex';
        }

        function deleteCourse(id, event) {
            if (event) event.stopPropagation();
            if (!confirm('ต้องการลบวิชานี้?')) return;
            
            const courses = getCourses().filter(c => c.id !== id);
            setCourses(courses);
            if (state.editingId === id) resetForm();
        }

        function clearPlan() {
            if (confirm('ยืนยันล้างตารางของแผนปัจจุบันทั้งหมด?')) {
                setCourses([]);
                showToast('ล้างตารางเรียบร้อย');
            }
        }

        document.getElementById('cancel-btn').addEventListener('click', resetForm);

        function resetForm() {
            state.editingId = null;
            document.getElementById('c-name').value = '';
            document.getElementById('c-sec').value = '';
            document.getElementById('c-credit').value = '3';
            document.getElementById('c-teacher').value = '';
            
            const addBtn = document.getElementById('add-btn');
            addBtn.innerHTML = '<i class="fa-solid fa-check"></i> เพิ่มวิชา';
            addBtn.style.backgroundColor = '';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // --- Drag & Drop ---
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const id = e.dataTransfer.getData('text/plain');
            const courses = getCourses();
            const course = courses.find(c => c.id === id);

            if (course) {
                const newDay = e.currentTarget.dataset.day;
                const newStart = parseInt(e.currentTarget.dataset.hour);
                const duration = course.end - course.start;

                if (newStart + duration > 20) {
                    showToast('วางไม่ได้ เวลาเกิน 20:00 น.', 'error');
                    return;
                }

                course.day = newDay;
                course.start = newStart;
                course.end = newStart + duration;
                setCourses(courses);
            }
        }

        // --- Export PDF ---
        document.getElementById('export-btn').addEventListener('click', async () => {
            const element = document.getElementById('schedule-capture-area');
            const btn = document.getElementById('export-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังสร้าง...';
            
            try {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                // Landscape A4
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                const imgProps = pdf.getImageProperties(imgData);
                const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
                
                const y = (pageHeight - pdfHeight) / 2;
                
                pdf.addImage(imgData, 'PNG', 0, y, pageWidth, pdfHeight);
                pdf.save(`MySchedule_${state.currentPlan}.pdf`);
                showToast('ดาวน์โหลดสำเร็จ!');
            } catch (err) {
                console.error(err);
                showToast('เกิดข้อผิดพลาดในการส่งออก', 'error');
            } finally {
                btn.innerHTML = originalText;
            }
        });

        // --- Toast Utility ---
        function showToast(msg, type='success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'error' ? '<i class="fa-solid fa-circle-exclamation" style="color:#ef4444"></i>' : '<i class="fa-solid fa-circle-check" style="color:#10b981"></i>';
            toast.innerHTML = `${icon} <span>${msg}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>